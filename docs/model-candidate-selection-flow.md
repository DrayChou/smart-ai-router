# Smart AI Router 模型候选选择流程详解

## 概述

Smart AI Router 采用多层级的模型候选选择策略，确保在成本优化、免费模型优先、智能匹配之间达到完美平衡。

## 完整流程图

```
用户请求 "qwen3-8b"
     ↓
┌─────────────────────────────────────────────────┐
│ 1. 请求类型判断                                   │
└─────────────────────────────────────────────────┘
     ↓
┌─────────────────────────────────────────────────┐
│ 是否以 "tag:" 开头？                              │
└─────────────────────────────────────────────────┘
     ↓                                    ↓
   【是】                                【否】
     ↓                                    ↓
┌────────────────┐                  ┌─────────────────────┐
│ A. 标签路由流程  │                  │ B. 综合搜索流程      │
└────────────────┘                  └─────────────────────┘
                                           ↓
                          ┌─────────────────────────────────────────┐
                          │ B1. 物理模型查找                          │
                          │ - 遍历所有启用的渠道                      │
                          │ - 查找精确匹配模型名的渠道                 │
                          └─────────────────────────────────────────┘
                                           ↓
                          ┌─────────────────────────────────────────┐
                          │ B2. 自动标签化查找                        │
                          │ - 从模型名提取标签: ["qwen3", "8b"]       │
                          │ - 查找包含这些标签的所有模型               │
                          └─────────────────────────────────────────┘
                                           ↓
                          ┌─────────────────────────────────────────┐
                          │ B3. 智能合并去重                          │
                          │ - 合并物理+标签候选                       │
                          │ - 去除重复的 channel+model 组合           │
                          └─────────────────────────────────────────┘
                                           ↓
                          ┌─────────────────────────────────────────┐
                          │ B4. 配置回退 (如无候选)                   │
                          │ - 从静态配置查找                          │
                          └─────────────────────────────────────────┘
                                           ↓
                          ┌─────────────────────────────────────────┐
                          │ 2. 渠道过滤                              │
                          │ - 健康状态检查                           │
                          │ - 可用性验证                             │
                          └─────────────────────────────────────────┘
                                           ↓
                          ┌─────────────────────────────────────────┐
                          │ 3. 7位数字评分排序                        │
                          │ - 成本|本地|上下文|参数|速度|质量|可靠性    │
                          │ - 免费模型绝对优先 (第1位=9)              │
                          └─────────────────────────────────────────┘
                                           ↓
                          ┌─────────────────────────────────────────┐
                          │ 4. 最终候选返回                           │
                          │ - 按评分降序排列                          │
                          │ - 供后续故障转移使用                      │
                          └─────────────────────────────────────────┘
```

## A. 标签路由流程 (tag: 前缀)

### A1. 多标签查询支持
```bash
# 支持的标签查询格式
tag:qwen3              # 单标签
tag:qwen3,free         # 多标签 (AND逻辑)
tag:qwen3,free,!local  # 包含免费，排除本地
tag:!local             # 纯排除查询
```

### A2. 标签解析过程
1. **分割标签**: 按逗号分割多个标签
2. **分类标签**: 
   - 正标签: `qwen3`, `free`
   - 负标签: `!local` (以!开头)
3. **调用标签匹配**: `_get_candidate_channels_by_auto_tags(positive_tags, negative_tags)`

## B. 综合搜索流程 (非tag前缀)

这是我们新优化的核心流程，确保免费模型优先。

### B1. 物理模型查找
```python
# 查找精确匹配的模型名称
for channel in all_enabled_channels:
    if request.model in discovered_info.get("models", []):
        physical_candidates.append(ChannelCandidate(
            channel=channel, 
            matched_model=request.model
        ))
```

**示例**: 用户请求 `qwen3-8b`
- 找到: AliBailian/qwen3-8b (付费)
- 找到: katonai.dev/qwen3-8b (付费)  
- 找到: tu-zi.com/qwen3-8b (付费)

### B2. 自动标签化查找
```python
# 从模型名提取标签
auto_tags = self._extract_tags_from_model_name("qwen3-8b")
# 结果: ["qwen3", "8b"]

# 查找包含这些标签的所有模型
auto_tag_candidates = self._get_candidate_channels_by_auto_tags(auto_tags)
```

**示例**: 标签 `["qwen3", "8b"]` 匹配到:
- openrouter/deepseek-r1-0528-qwen3-8b:free (免费)
- openrouter/qwen/qwen3-8b:free (免费)
- lmstudio/qwen3-8b-local (本地免费)
- siliconflow/Qwen/Qwen3-8B:free (免费)

### B3. 智能合并去重
```python
# 合并两类候选，避免重复
all_candidates = physical_candidates.copy()
for tag_candidate in auto_tag_candidates:
    if not duplicate_found:  # 检查 channel.id + matched_model 是否重复
        all_candidates.append(tag_candidate)
```

**关键优势**: 确保既包含精确匹配，也包含相似免费替代品。

### B4. 配置回退
如果前面步骤都没找到候选：
```python
config_channels = self.config_loader.get_channels_by_model(request.model)
```

## 2. 渠道过滤阶段

### 健康状态检查
- 检查渠道是否启用
- 验证API密钥有效性
- 确认服务可用性

### 能力匹配验证
- 验证模型是否支持请求的功能
- 检查上下文长度限制
- 确认输出格式兼容性

## 3. 7位数字评分排序

### 评分维度详解

| 位数 | 维度 | 范围 | 说明 |
|------|------|------|------|
| 1 | 成本 | 0-9 | **免费=9，付费最高=8** (绝对优先) |
| 2 | 本地 | 0-9 | 本地=9，远程=0-8 |
| 3 | 上下文 | 0-9 | 上下文长度评分 |
| 4 | 参数量 | 0-9 | 模型参数数量评分 |
| 5 | 速度 | 0-9 | 推理速度评分 |
| 6 | 质量 | 0-9 | 模型质量评分 |
| 7 | 可靠性 | 0-9 | 服务可靠性评分 |

### 评分示例
```
免费本地模型: 9977769 (9,977,769)
免费远程模型: 9077689 (9,077,689)  
付费本地模型: 8977689 (8,977,689)
付费远程模型: 8077689 (8,077,689)
```

### 排序逻辑
```python
hierarchical_score = (
    cost_tier * 1000000 +       # 第1位：成本(免费=9,付费最高=8)
    local_tier * 100000 +       # 第2位：本地
    context_tier * 10000 +      # 第3位：上下文
    parameter_tier * 1000 +     # 第4位：参数量
    speed_tier * 100 +          # 第5位：速度
    quality_tier * 10 +         # 第6位：质量
    reliability_tier            # 第7位：可靠性
)
return -hierarchical_score  # 负数实现降序排列
```

## 4. 自动标签提取规则

### 分隔符支持
支持的分隔符: `:`, `/`, `@`, `-`, `_`, `,`

### 提取示例
```python
"qwen/qwen3-30b-a3b:free" → ["qwen", "qwen3", "30b", "a3b", "free"]
"openai/gpt-4o-mini" → ["openai", "gpt", "4o", "mini"]  
"anthropic/claude-3-haiku:free" → ["anthropic", "claude", "3", "haiku", "free"]
"deepseek-r1-0528-qwen3-8b:free" → ["deepseek", "r1", "0528", "qwen3", "8b", "free"]
```

### 过滤规则
- 移除空字符串和纯数字
- 转换为小写
- 长度限制 (1-50字符)
- 排除常见无意义词汇

## 使用场景对比

### 场景1: 用户请求 "qwen3-8b"

**之前的行为** (仅物理匹配):
```
候选: 3个 (都是付费)
- AliBailian/qwen3-8b [PAID] Score: 4077769
- katonai.dev/qwen3-8b [PAID] Score: 4077769  
- tu-zi.com/qwen3-8b [PAID] Score: 4077769
选择: katonai.dev (付费)
```

**现在的行为** (综合搜索):
```
候选: 31个 (包含免费)
- openrouter.free/deepseek-r1-0528-qwen3-8b:free [FREE] Score: 9087779
- openrouter/qwen3-8b:free [FREE] Score: 9087779
- lmstudio/qwen3-8b [FREE/LOCAL] Score: 9977769
- AliBailian/qwen3-8b [PAID] Score: 4077769
选择: lmstudio (免费+本地) 或 openrouter.free (免费+远程)
```

### 场景2: 用户请求 "tag:free"

**行为**: 纯标签路由
```
候选: 所有免费模型
排序: 按本地>远程>上下文>参数>速度>质量>可靠性
选择: 最优免费模型
```

### 场景3: 用户请求 "tag:qwen3,free"

**行为**: 多标签AND逻辑
```
候选: 同时包含 qwen3 AND free 标签的模型
排序: 7位数字评分
选择: 最优免费qwen3模型
```

## 优势总结

### 1. 成本优化最大化
- **免费绝对优先**: 免费模型永远排在付费模型前面
- **本地优先**: 降低API调用成本和延迟
- **智能回退**: 免费不可用时选择最便宜付费选项

### 2. 用户体验最佳
- **无需修改请求**: `"model": "qwen3-8b"` 自动找到免费替代
- **智能匹配**: 自动扩展搜索范围，提高匹配成功率
- **透明定价**: 响应中显示实际成本

### 3. 系统可靠性
- **多层回退**: 物理→标签→配置→错误
- **故障转移**: 排序后的候选列表支持自动故障转移
- **去重机制**: 避免重复候选和循环请求

### 4. 可观测性强
- **详细日志**: 每个步骤都有清晰的日志输出
- **评分透明**: 7位数字评分便于调试和理解
- **统计信息**: 候选数量、匹配类型、选择原因

这种设计确保了 Smart AI Router 能够在保持用户使用简便性的同时，最大化成本优化和服务质量。