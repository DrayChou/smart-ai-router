# Smart AI Router - 开发TODO列表

## 📋 项目开发进度

### ✅ 已完成

#### Phase 1: 核心架构与功能
- [x] **基础架构**: 项目结构、分层配置、数据库设计、FastAPI框架、Docker配置。
- [x] **数据管理**: 数据库初始化、One-API数据导入、虚拟模型组创建。
- [x] **核心引擎**: 智能路由引擎、多层评分策略、Provider适配器模式、YAML配置加载。
- [x] **API接口**: 完整的OpenAI兼容接口 (`/chat/completions`, `/models`, `/health`)。
- [x] **配置系统**: 统一`main.py`入口，以YAML为核心，移除多余的`json/sqlite`模式。

#### 近期修复与重构 (Recent Fixes & Refactoring)
- [x] **BUG修复**: 解决了伪流式响应、`unhashable dict`、`str object has no attribute get`等多个核心BUG。
- [x] **故障转移 (Fallback)**: 实现了真正的渠道故障转移机制，当首选渠道失败时自动尝试备用渠道。
- [x] **智能物理模型路由**: 支持直接请求任意已发现的物理模型，系统会自动反向查找可用渠道。
- [x] **配置结构优化**: 将`providers`配置拆分到独立的`providers.yaml`，使配置更清晰。
- [x] **错误处理增强**: 优化了500/503错误处理，现在会向客户端返回结构化的错误信息，并在服务端记录详细日志。
- [x] **Token计算优化**: 引入`tiktoken`库，实现更精确的Token计算。

## 🎯 项目当前状态

### 🏆 核心功能已稳定
一个健壮的、面向个人开发者的AI路由网关。核心的智能路由、故障转移、模型发现和OpenAI兼容API均已稳定运行。

### 📊 技术架构
- **入口**: `main.py` (纯YAML模式)
- **配置**: `config/router_config.yaml` (渠道、路由) 和 `config/providers.yaml` (服务商)
- **API**: 完整OpenAI兼容接口
- **路由**: 支持虚拟模型组和物理模型的智能路由，具备自动故障转移能力。

---

## 🚀 Phase 2: 智能标签系统 ✅ 已完成

### ✅ P0 - 智能标签系统 (Tag-Based Routing System)
**核心创新**: 基于模型名称的**自动标签化系统**，完全替代了传统的 Model Groups 概念。

- [x] **自动标签提取**: 从模型名称自动提取标签，使用 `:`, `/`, `@`, `-`, `_` 等分隔符
- [x] **标签路由实现**: 支持 `tag:gpt`, `tag:claude,free` 等灵活的标签查询
- [x] **多标签组合**: 支持逗号分隔的多标签查询，如 `tag:qwen,mini`
- [x] **智能匹配**: 自动找到包含所有指定标签的渠道和模型
- [x] **实时更新**: 新发现的模型会自动更新可用标签列表
- [x] **API密钥验证**: 自动检测失效API密钥，智能管理渠道状态
- [x] **文档更新**: 更新 README.md、CLAUDE.md 等文档

### ✅ P0.5 - 标签路由优化与调试功能 (Tag Routing Optimization & Debugging)
**最新完成**: 修复标签路由关键问题，添加全面调试支持。

- [x] **标签路由BUG修复**: 解决 `tag:free,kimi` 返回错误模型的问题
- [x] **匹配模型保持**: 实现 `ChannelCandidate` 数据结构，确保标签路由使用正确的匹配模型
- [x] **错误处理完善**: 添加 `TagNotFoundError` 异常，对不存在的标签返回明确错误信息
- [x] **调试头信息**: 添加完整的 `X-Router-*` 调试头，包含渠道、厂商、模型、评分等信息
- [x] **健康检查修复**: 修复 `service_health_check.py` 中模型格式处理问题
- [x] **路由策略验证**: 确认标签搜索结果按价格(30%)、速度(30%)、质量(20%)、可靠性(20%)排序
- [x] **性能优化**: 标签提取缓存机制，性能提升4.2倍
- [x] **全面测试**: 创建测试脚本验证标签路由和调试功能

### 🎯 标签系统特性
- **标签提取示例**:
  ```
  qwen/qwen3-30b-a3b:free -> ["qwen", "qwen3", "30b", "a3b", "free"]
  openai/gpt-4o-mini -> ["openai", "gpt", "4o", "mini"]
  ```
- **查询方式**: `tag:gpt` (单标签), `tag:claude,free` (多标签)
- **自动化**: 无需手动配置标签，完全基于模型发现结果
- **调试支持**: 响应头包含完整的路由决策信息，便于问题诊断

## 🚀 Phase 3: 代码质量与高级功能

### P1 - 代码质量提升 (High Priority) 🔧
**基于代码审核结果的改进计划**

#### 立即修复 (本周)
- [ ] **流式请求故障转移修复**:
    - **问题**: 流式请求无法进行故障转移，影响系统可靠性
    - **方案**: 实现连接预检查机制和流式故障恢复
- [ ] **函数重构 (main.py)**:
    - **问题**: `chat_completions` 函数过长(173行)，职责不清
    - **方案**: 拆分为 `route_request` 和 `execute_with_fallback` 等函数
- [ ] **类型注解补全**:
    - **问题**: 部分函数缺少返回类型注解
    - **方案**: 为所有公共函数添加完整类型注解

#### 短期改进 (下周)
- [ ] **统一错误处理机制**:
    - **问题**: 错误处理逻辑分散，缺乏统一性
    - **方案**: 创建异常类层次结构和错误处理中间件
- [ ] **异步文件操作优化**:
    - **问题**: 模型发现任务中同步文件I/O可能阻塞事件循环
    - **方案**: 使用 `aiofiles` 替换同步文件操作
- [ ] **代码重复消除**:
    - **问题**: Token计算逻辑在多个文件重复
    - **方案**: 创建独立的 `TokenCounter` 工具类

#### 长期优化 (后续)
- [ ] **依赖注入系统**:
    - **目标**: 提高组件可测试性和解耦度
    - **方案**: 实现依赖注入容器
- [ ] **监控和可观测性**:
    - **目标**: 添加Prometheus指标和分布式追踪
    - **方案**: 集成metrics中间件和健康检查端点

### P2 - 功能增强 (Medium Priority)
- [x] **实现动态 `speed_score`**: ✅ 已完成，基于历史平均延迟计算
- [x] **实现真正的 `quality_optimized` 策略**: ✅ 已完成，内置模型质量排名
- [x] **集成 Pydantic 进行配置验证**: ✅ 已完成，使用 `config_models.py`

### P2 - 安全与易用性 (Medium Priority)
- [ ] **实现全局认证系统**:
    - **目标**: 为路由网关本身增加一层安全保护。
    - **实现**:
        - [ ] 在 `router_config.yaml` 中增加一个 `auth:` 部分，用于定义主API Key。
        - [ ] 增加一个FastAPI中间件，用于校验所有请求的 `Authorization` 头。
        - [ ] **(高级)** 实现主API Key到 `tags` 的访问控制。例如，Key A只能访问带 `free` 标签的渠道，Key B可以访问所有。
- [ ] **完善启动信息和 `README.md`**:
    - **目标**: 让用户对系统状态一目了然。
    - **实现**:
        - [ ] 修改 `main.py` 的启动打印信息，清晰地列出加载了多少个渠道，以及发现了多少个可用的 `tags`。
        - [ ] 在 `README.md` 中详细说明标签系统的使用方法和所有新功能。

### P3 - 高级功能 (Future)
- [ ] **Web管理界面**: 用于查看渠道状态、实时日志和编辑配置。
- [ ] **余额查询**: 集成 `llm-api-key-checker` 的能力，自动监控渠道余额。
