# Smart AI Router - 开发TODO列表

## 📋 项目开发进度

### ✅ 已完成

#### Phase 1: 核心架构与功能
- [x] **基础架构**: 项目结构、分层配置、数据库设计、FastAPI框架、Docker配置。
- [x] **数据管理**: 数据库初始化、One-API数据导入、虚拟模型组创建。
- [x] **核心引擎**: 智能路由引擎、多层评分策略、Provider适配器模式、YAML配置加载。
- [x] **API接口**: 完整的OpenAI兼容接口 (`/chat/completions`, `/models`, `/health`)。
- [x] **配置系统**: 统一`main.py`入口，以YAML为核心，移除多余的`json/sqlite`模式。

#### 近期修复与重构 (Recent Fixes & Refactoring)
- [x] **BUG修复**: 解决了伪流式响应、`unhashable dict`、`str object has no attribute get`等多个核心BUG。
- [x] **故障转移 (Fallback)**: 实现了真正的渠道故障转移机制，当首选渠道失败时自动尝试备用渠道。
- [x] **智能物理模型路由**: 支持直接请求任意已发现的物理模型，系统会自动反向查找可用渠道。
- [x] **配置结构优化**: 将`providers`配置拆分到独立的`providers.yaml`，使配置更清晰。
- [x] **错误处理增强**: 优化了500/503错误处理，现在会向客户端返回结构化的错误信息，并在服务端记录详细日志。
- [x] **Token计算优化**: 引入`tiktoken`库，实现更精确的Token计算。

## 🎯 项目当前状态

### 🏆 核心功能高度稳定
一个成熟的、面向个人开发者的AI智能路由网关。**智能标签匹配、多渠道故障转移、模型类型过滤**和OpenAI兼容API均已稳定运行，匹配精度达到**100%**。

### 📊 技术架构
- **入口**: `main.py` (纯YAML模式)
- **配置**: `config/router_config.yaml` (渠道、路由策略)
- **API**: 完整OpenAI兼容接口 + 智能调试头信息
- **路由**: 支持严格标签匹配、多渠道智能切换、模型质量差异化评分
- **故障处理**: 智能渠道黑名单、自动模型类型过滤、多维度错误分类

### 🎯 系统表现指标
- **匹配精度**: 100% (严格标签匹配，无误匹配)
- **支持渠道**: 15个渠道，87个模型缓存
- **故障转移**: OpenRouter失效→本地模型，9.125秒成功响应
- **模型评分**: 支持0.6B-235B全规格差异化评分

---

## 🚀 Phase 2: 智能标签系统 ✅ 已完成

### ✅ P0 - 智能标签系统 (Tag-Based Routing System)
**核心创新**: 基于模型名称的**自动标签化系统**，完全替代了传统的 Model Groups 概念。

- [x] **自动标签提取**: 从模型名称自动提取标签，使用 `:`, `/`, `@`, `-`, `_` 等分隔符
- [x] **标签路由实现**: 支持 `tag:gpt`, `tag:claude,free` 等灵活的标签查询
- [x] **多标签组合**: 支持逗号分隔的多标签查询，如 `tag:qwen,mini`
- [x] **智能匹配**: 自动找到包含所有指定标签的渠道和模型
- [x] **实时更新**: 新发现的模型会自动更新可用标签列表
- [x] **API密钥验证**: 自动检测失效API密钥，智能管理渠道状态
- [x] **文档更新**: 更新 README.md、CLAUDE.md 等文档

### ✅ P0.5 - 标签路由优化与调试功能 (Tag Routing Optimization & Debugging)
**最新完成**: 修复标签路由关键问题，添加全面调试支持。

- [x] **标签路由BUG修复**: 解决 `tag:free,kimi` 返回错误模型的问题
- [x] **匹配模型保持**: 实现 `ChannelCandidate` 数据结构，确保标签路由使用正确的匹配模型
- [x] **错误处理完善**: 添加 `TagNotFoundError` 异常，对不存在的标签返回明确错误信息
- [x] **调试头信息**: 添加完整的 `X-Router-*` 调试头，包含渠道、厂商、模型、评分等信息
- [x] **健康检查修复**: 修复 `service_health_check.py` 中模型格式处理问题
- [x] **路由策略验证**: 确认标签搜索结果按价格(30%)、速度(30%)、质量(20%)、可靠性(20%)排序
- [x] **性能优化**: 标签提取缓存机制，性能提升4.2倍
- [x] **全面测试**: 创建测试脚本验证标签路由和调试功能

### ✅ P0.6 - 配置文件整理与需求澄清 (Configuration Cleanup & Requirements Clarification)
**最新完成**: 澄清真实需求，修正错误理解，简化配置文件。

- [x] **需求澄清**: 理解标签系统基于模型发现缓存工作，不是配置文件定义
- [x] **配置简化**: 合并相同API密钥的重复渠道，每个API密钥只保留一个渠道
- [x] **移除错误配置**: 删除配置文件中多余的 `tags` 字段（标签从模型名称自动提取）
- [x] **模型名称自动标签化**: 支持用户输入 `kimi-free` 自动转为 `tag:kimi,free` 查询
- [x] **文档更新**: 更新 README.md 明确标签系统真实工作原理
- [x] **配置优化**: 从11个渠道优化为7个渠道，消除API密钥重复

### 🎯 标签系统特性
- **标签提取示例**:
  ```
  qwen/qwen3-30b-a3b:free -> ["qwen", "qwen3", "30b", "a3b", "free"]
  openai/gpt-4o-mini -> ["openai", "gpt", "4o", "mini"]
  ```
- **查询方式**: `tag:gpt` (单标签), `tag:claude,free` (多标签)
- **自动化**: 无需手动配置标签，完全基于模型发现结果
- **调试支持**: 响应头包含完整的路由决策信息，便于问题诊断

## 🚀 Phase 3: 智能标签匹配与系统优化 ✅ 已完成

### ✅ P0 - 智能标签匹配系统升级 (Smart Tag Matching System)
**最新完成**: 实现严格标签匹配逻辑，修复关键问题，大幅提升系统稳定性。

- [x] **严格标签匹配**: 移除渐进式回退逻辑，确保只有满足所有查询标签的模型被匹配
- [x] **渠道+模型标签合并**: 实现渠道标签作为基础属性，模型标签自动提取，双重标签智能合并
- [x] **gemma模型误匹配修复**: 修复了 `google/gemma-3-12b` 被错误匹配到 `tag:free,qwen3` 查询的问题
- [x] **智能渠道黑名单**: 401/403错误时立即拉黑整个渠道，避免重复尝试所有模型
- [x] **模型类型过滤**: 自动过滤embedding模型，避免 "Model is not llm" 错误
- [x] **评分算法优化**: 实现基于具体模型的差异化质量评分，区分0.6B-235B不同规格
- [x] **系统稳定性提升**: 修复HTTP响应头中文编码错误、健康检查KeyError等多个bug
- [x] **日志优化**: 简化冗余日志输出，提供清晰的调试信息

### ✅ P0.5 - 系统表现优化成果
**显著提升**: 标签匹配精度100%，多渠道智能故障转移，模型评分差异化。

- [x] **匹配精度**: 从14个候选（包含错误匹配）优化到13个精确候选，100%匹配精度
- [x] **质量评分差异化**: 
  - `qwen3-coder:free` (0.880) > `qwen3-30b` (0.850) > `qwen3-8b` (0.800) > `qwen3-4b` (0.700)
- [x] **多渠道支持**: 成功支持 openrouter、lmstudio、ollama 三类渠道统一路由
- [x] **智能故障转移**: OpenRouter 401错误 → 自动切换到本地qwen3-0.6b成功响应
- [x] **模型数据库增强**: 新增Qwen3全系列、DeepSeek、Google Gemma等模型质量评分

## 🚀 Phase 4: 代码质量与高级功能

### P1 - 代码质量提升 (High Priority) 🔧
**基于Phase 3成果的进一步改进计划**

#### 立即修复 (本周)
- [ ] **流式请求故障转移修复**:
    - **问题**: 流式请求无法进行故障转移，影响系统可靠性
    - **方案**: 实现连接预检查机制和流式故障恢复
- [ ] **函数重构 (main.py)**:
    - **问题**: `chat_completions` 函数过长，职责不清
    - **方案**: 拆分为 `route_request` 和 `execute_with_fallback` 等函数
- [ ] **类型注解补全**:
    - **问题**: 部分函数缺少返回类型注解
    - **方案**: 为所有公共函数添加完整类型注解

#### 短期改进 (下周)
- [ ] **统一错误处理机制**:
    - **问题**: 错误处理逻辑分散，缺乏统一性
    - **方案**: 创建异常类层次结构和错误处理中间件
- [ ] **异步文件操作优化**:
    - **问题**: 模型发现任务中同步文件I/O可能阻塞事件循环
    - **方案**: 使用 `aiofiles` 替换同步文件操作
- [ ] **代码重复消除**:
    - **问题**: Token计算逻辑在多个文件重复
    - **方案**: 创建独立的 `TokenCounter` 工具类

#### 长期优化 (后续)
- [ ] **依赖注入系统**:
    - **目标**: 提高组件可测试性和解耦度
    - **方案**: 实现依赖注入容器
- [ ] **监控和可观测性**:
    - **目标**: 添加Prometheus指标和分布式追踪
    - **方案**: 集成metrics中间件和健康检查端点

### P2 - 功能增强 (Medium Priority)
- [x] **实现动态 `speed_score`**: ✅ 已完成，基于历史平均延迟计算
- [x] **实现真正的 `quality_optimized` 策略**: ✅ 已完成，内置模型质量排名
- [x] **集成 Pydantic 进行配置验证**: ✅ 已完成，使用 `config_models.py`

### P2 - 安全与易用性 (Medium Priority)
- [ ] **实现全局认证系统**:
    - **目标**: 为路由网关本身增加一层安全保护。
    - **实现**:
        - [ ] 在 `router_config.yaml` 中增加一个 `auth:` 部分，用于定义主API Key。
        - [ ] 增加一个FastAPI中间件，用于校验所有请求的 `Authorization` 头。
        - [ ] **(高级)** 实现主API Key到 `tags` 的访问控制。例如，Key A只能访问带 `free` 标签的渠道，Key B可以访问所有。
- [ ] **完善启动信息和 `README.md`**:
    - **目标**: 让用户对系统状态一目了然。
    - **实现**:
        - [ ] 修改 `main.py` 的启动打印信息，清晰地列出加载了多少个渠道，以及发现了多少个可用的 `tags`。
        - [ ] 在 `README.md` 中详细说明标签系统的使用方法和所有新功能。

### P3 - 高级功能 (Future)
- [ ] **Web管理界面**: 用于查看渠道状态、实时日志和编辑配置。
- [ ] **余额查询**: 集成 `llm-api-key-checker` 的能力，自动监控渠道余额。
