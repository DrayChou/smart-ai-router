# Smart AI Router - å›½å†…é•œåƒä¼˜åŒ–ç‰ˆ
# ä½¿ç”¨é“äº‘é•œåƒåŠ é€Ÿï¼Œé’ˆå¯¹å›½å†…ç½‘ç»œç¯å¢ƒä¼˜åŒ–
FROM docker.m.daocloud.io/library/python:3.11-slim

WORKDIR /app

ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1
ENV PATH="/home/app/.local/bin:$PATH"

# HTTPâ†’HTTPSæ™ºèƒ½æºåˆ‡æ¢ç­–ç•¥ï¼ˆä¼˜åŒ–æ„å»ºé€Ÿåº¦å’Œå¯é æ€§ï¼‰
RUN echo "ğŸ‡¨ğŸ‡³ ç¬¬ä¸€æ­¥ï¼šé…ç½®HTTPé•œåƒæºï¼ˆç»•è¿‡è¯ä¹¦éªŒè¯ï¼‰..." && \
    # å¤‡ä»½åŸå§‹æº
    cp /etc/apt/sources.list /etc/apt/sources.list.backup 2>/dev/null || true && \
    # ä½¿ç”¨HTTPé˜¿é‡Œäº‘é•œåƒæºï¼ˆé¿å…HTTPSè¯ä¹¦éªŒè¯æ­»å¾ªç¯ï¼‰
    echo 'deb http://mirrors.aliyun.com/debian/ bookworm main contrib non-free non-free-firmware' > /etc/apt/sources.list && \
    echo 'deb http://mirrors.aliyun.com/debian/ bookworm-updates main contrib non-free non-free-firmware' >> /etc/apt/sources.list && \
    echo 'deb http://mirrors.aliyun.com/debian-security bookworm-security main contrib non-free non-free-firmware' >> /etc/apt/sources.list && \
    # æ¸…ç†å…¶ä»–æºé…ç½®
    rm -rf /etc/apt/sources.list.d/* 2>/dev/null || true && \
    # ç¬¬äºŒæ­¥ï¼šä½¿ç”¨HTTPæºå®‰è£…ca-certificates
    echo "ğŸ‡¨ğŸ‡³ ç¬¬äºŒæ­¥ï¼šä½¿ç”¨HTTPæºå®‰è£…ca-certificates..." && \
    apt-get update && \
    apt-get install -y --no-install-recommends ca-certificates && \
    # ç¬¬ä¸‰æ­¥ï¼šå‡çº§ä¸ºHTTPSæºï¼ˆå®‰å…¨åŠ å›ºï¼‰
    echo "ğŸ‡¨ğŸ‡³ ç¬¬ä¸‰æ­¥ï¼šå‡çº§ä¸ºHTTPSæº..." && \
    sed -i 's|http://|https://|g' /etc/apt/sources.list && \
    apt-get update && \
    apt-get clean && \
    echo "âœ… æºé…ç½®å®Œæˆï¼ˆHTTPâ†’HTTPSå‡çº§ç­–ç•¥ï¼‰"

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    && rm -rf /var/lib/apt/lists/*

# åˆ›å»ºérootç”¨æˆ·(åœ¨å®‰è£…ä¾èµ–å‰)
RUN useradd --create-home app && chown -R app:app /app
USER app

# å¤åˆ¶å¿…è¦æ–‡ä»¶
COPY --chown=app:app pyproject.toml README.md ./

# ä½¿ç”¨æ¸…åå¤§å­¦PyPIé•œåƒå®‰è£…uvå’Œé¡¹ç›®ä¾èµ–
RUN pip install --no-cache-dir --upgrade pip -i https://pypi.tuna.tsinghua.edu.cn/simple && \
    pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple && \
    pip install uv -i https://pypi.tuna.tsinghua.edu.cn/simple && \
    export PATH="/home/app/.local/bin:$PATH" && \
    uv sync --no-dev --index-url https://pypi.tuna.tsinghua.edu.cn/simple

# å¤åˆ¶åº”ç”¨ä»£ç 
COPY --chown=app:app . .

# åˆ›å»ºå¿…è¦ç›®å½•
RUN mkdir -p logs cache

EXPOSE 7601

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=30s --start-period=30s --retries=3 \
    CMD curl -f http://localhost:7601/health || exit 1

# å¯åŠ¨å‘½ä»¤ï¼ˆä½¿ç”¨è™šæ‹Ÿç¯å¢ƒä¸­çš„Pythonï¼‰
CMD [".venv/bin/python", "main.py"]