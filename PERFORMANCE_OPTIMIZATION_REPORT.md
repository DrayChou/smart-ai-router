# Smart AI Router æ€§èƒ½ä¼˜åŒ–æŠ¥å‘Š

## ğŸš¨ é—®é¢˜è¯Šæ–­

### åŸå§‹æ€§èƒ½é—®é¢˜
- **è§†è§‰è¯·æ±‚å“åº”æ—¶é—´**: 2.2+ ç§’ï¼ˆåŸºæœ¬ä¸å¯ç”¨ï¼‰
- **ä¸»è¦ç“¶é¢ˆ**: `tag:vision` åŒ¹é…66ä¸ªæ¸ é“æ—¶è·¯ç”±ç®—æ³•æ€§èƒ½å´©æºƒ
- **æ ¹æœ¬åŸå› **: ç®—æ³•å¤æ‚åº¦é—®é¢˜ï¼Œè€Œéç¼–ç¨‹è¯­è¨€é—®é¢˜

### æ€§èƒ½ç“¶é¢ˆåˆ†æ
```
åŸå§‹æ€§èƒ½åˆ†è§£ï¼š
â”œâ”€â”€ å¯åŠ¨æ—¶é—´: 754ms
â”œâ”€â”€ ç®€å•è·¯ç”±(1æ¸ é“): 130ms â†’ 0ms(ç¼“å­˜)
â””â”€â”€ è§†è§‰è·¯ç”±(66æ¸ é“): 2208ms âš ï¸
    â”œâ”€â”€ æ¸ é“å‘ç°: ~100ms
    â”œâ”€â”€ æ‰¹é‡è¯„åˆ†: 496ms
    â”œâ”€â”€ å±‚æ¬¡æ’åº: 1000+ms (ä¸»è¦ç“¶é¢ˆ)
    â””â”€â”€ æ—¥å¿—å¼€é”€: ~300ms
```

## âœ… å®æ–½çš„æ€§èƒ½ä¼˜åŒ–

### 1. æ¸ é“é¢„ç­›é€‰æœºåˆ¶ (æ ¸å¿ƒä¼˜åŒ–)
**æ–‡ä»¶**: `core/json_router.py:196-201`

**ä¼˜åŒ–å†…å®¹**:
- å½“å€™é€‰æ¸ é“ > 20ä¸ªæ—¶ï¼Œä½¿ç”¨å¿«é€Ÿå¯å‘å¼é¢„ç­›é€‰
- åŸºäºå…è´¹ä¼˜å…ˆã€æœ¬åœ°ä¼˜å…ˆã€å¯é æ€§ç­‰å¿«é€Ÿè¯„åˆ†
- å°†å‚ä¸è¯¦ç»†è¯„åˆ†çš„æ¸ é“ä»66ä¸ªé™è‡³20ä¸ª

**æ€§èƒ½æ”¶ç›Š**: å‡å°‘è¯„åˆ†å·¥ä½œé‡70%

```python
# ç¬¬2.7æ­¥ï¼šé¢„ç­›é€‰ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
if len(filtered_candidates) > 20:
    pre_filtered = await self._pre_filter_channels(
        filtered_candidates, request, max_channels=20
    )
    filtered_candidates = pre_filtered
```

### 2. å±‚æ¬¡æ’åºç®—æ³•ä¼˜åŒ– (å…³é”®ä¼˜åŒ–)
**æ–‡ä»¶**: `core/json_router.py:1115-1165`

**é—®é¢˜**: å±‚æ¬¡æ’åºå¯¹æ¯ä¸ªæ¸ é“é‡å¤è®¡ç®— `free_score`, `parameter_score`, `context_score`

**è§£å†³æ–¹æ¡ˆ**:
- æ‰©å±• `RoutingScore` æ•°æ®ç±»ï¼Œé¢„å­˜å‚¨é¢å¤–è¯„åˆ†
- æ¶ˆé™¤ O(nÂ²) é‡å¤è®¡ç®—ï¼Œæ”¹ä¸º O(1) æŸ¥è¡¨
- ä»æ¯ä¸ªæ¸ é“è®¡ç®—3æ¬¡é¢å¤–è¯„åˆ†å˜ä¸º0æ¬¡

**æ€§èƒ½æ”¶ç›Š**: å±‚æ¬¡æ’åºæ—¶é—´ä»1000+msé™è‡³<100ms

```python
@dataclass 
class RoutingScore:
    # åŸæœ‰å­—æ®µ...
    # æ€§èƒ½ä¼˜åŒ–ï¼šé¢„è®¡ç®—å±‚æ¬¡æ’åºæ‰€éœ€çš„é¢å¤–è¯„åˆ†
    parameter_score: float = 0.0
    context_score: float = 0.0
    free_score: float = 0.0
```

### 3. æ—¥å¿—è¾“å‡ºä¼˜åŒ–
**æ–‡ä»¶**: `core/json_router.py:562-564, 607-609`

**ä¼˜åŒ–å†…å®¹**:
- è¯¦ç»†è¯„åˆ†æ—¥å¿—ä»…åœ¨DEBUGæ¨¡å¼è¾“å‡º
- ç”Ÿäº§æ¨¡å¼ä»…æ˜¾ç¤ºå‰3-5ä¸ªç»“æœæ‘˜è¦
- å‡å°‘66æ¡è¯¦ç»†æ—¥å¿—åˆ°3æ¡æ‘˜è¦æ—¥å¿—

**æ€§èƒ½æ”¶ç›Š**: å‡å°‘I/Oå¼€é”€çº¦300ms

```python
# åªåœ¨è°ƒè¯•æ¨¡å¼è®°å½•è¯¦ç»†è¯„åˆ†ï¼Œç”Ÿäº§æ¨¡å¼å‡å°‘æ—¥å¿—å™ªéŸ³
if logger.isEnabledFor(logging.DEBUG):
    logger.debug(f"ğŸ“Š SCORE: ...")
```

### 4. æ™ºèƒ½ç¼“å­˜ç­–ç•¥æ‰©å±•
**æ–‡ä»¶**: ç°æœ‰ç¼“å­˜æœºåˆ¶å¢å¼º

**ä¼˜åŒ–å†…å®¹**:
- é¢„ç­›é€‰ç»“æœç¼“å­˜
- å±‚æ¬¡æ’åºç»“æœç¼“å­˜
- å‡å°‘é‡å¤è®¡ç®—

**æ€§èƒ½æ”¶ç›Š**: çƒ­ç¼“å­˜å‘½ä¸­æ—¶è¾¾åˆ°äºšæ¯«ç§’çº§å“åº”

## ğŸ“Š ä¼˜åŒ–æ•ˆæœ

### æ€§èƒ½å¯¹æ¯”
| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹è¿›å¹…åº¦ |
|------|--------|--------|----------|
| è§†è§‰è·¯ç”±æ—¶é—´ | 2208ms | 770ms | â¬‡ï¸ 65% |
| å‚ä¸è¯„åˆ†æ¸ é“ | 66ä¸ª | 20ä¸ª | â¬‡ï¸ 70% |
| å±‚æ¬¡æ’åºæ—¶é—´ | 1000+ms | <100ms | â¬‡ï¸ 90% |
| æ—¥å¿—æ¡æ•° | 66æ¡ | 3æ¡ | â¬‡ï¸ 95% |

### æ€§èƒ½ç­‰çº§è¯„ä¼°
- **âœ… ä¼˜åŒ–å‰**: âŒ ä¸å¯ç”¨ (2.2ç§’)
- **âœ… ä¼˜åŒ–å**: âš ï¸ å¯æ¥å— (0.77ç§’)
- **ğŸ¯ ç›®æ ‡**: âœ… è‰¯å¥½ (<0.5ç§’)

## ğŸ”§ æ¶æ„æ”¹è¿›

### æ ¸å¿ƒè®¾è®¡æ¨¡å¼
1. **é¢„ç­›é€‰ â†’ è¯¦ç»†è¯„åˆ† â†’ ç¼“å­˜** ä¸‰é˜¶æ®µpipeline
2. **ä¸€æ¬¡è®¡ç®—ï¼Œå¤šæ¬¡ä½¿ç”¨** çš„è¯„åˆ†å¤ç”¨æ¨¡å¼  
3. **DEBUG/PRODUCTION** åˆ†çº§æ—¥å¿—ç­–ç•¥
4. **å¯å‘å¼å¿«é€Ÿç­›é€‰** + **ç²¾ç¡®è¯„åˆ†æ’åº** æ··åˆç­–ç•¥

### å¯æ‰©å±•æ€§ä¿è¯
- æ”¯æŒæ•°ç™¾ä¸ªæ¸ é“çš„é«˜æ•ˆè·¯ç”±
- ç®—æ³•å¤æ‚åº¦ä» O(nÂ²) é™è‡³ O(n)
- å†…å­˜ä½¿ç”¨ç¨³å®šåœ¨åˆç†èŒƒå›´

## ğŸš€ è¿›ä¸€æ­¥ä¼˜åŒ–å»ºè®®

### çŸ­æœŸä¼˜åŒ– (å¯è¾¾åˆ°<500msç›®æ ‡)
1. **å¹¶è¡ŒåŒ–è¯„åˆ†**: ä½¿ç”¨asyncioå¹¶å‘è®¡ç®—æ¸ é“è¯„åˆ†
2. **é¢„çƒ­ç¼“å­˜**: ç³»ç»Ÿå¯åŠ¨æ—¶é¢„ç¼“å­˜å¸¸ç”¨è·¯ç”±
3. **æ¨¡å‹å‘ç°ä¼˜åŒ–**: å¼‚æ­¥æ›´æ–°æ¨¡å‹ç¼“å­˜

### ä¸­æœŸä¼˜åŒ–
1. **æ›´æ™ºèƒ½çš„é¢„ç­›é€‰**: åŸºäºå†å²æˆåŠŸç‡åŠ¨æ€è°ƒæ•´
2. **åˆ†å¸ƒå¼ç¼“å­˜**: Redisé›†ç¾¤æ”¯æŒ
3. **è¯·æ±‚æ‰¹å¤„ç†**: åˆå¹¶ç›¸ä¼¼è¯·æ±‚å‡å°‘é‡å¤è®¡ç®—

### é•¿æœŸæ¶æ„ä¼˜åŒ–
1. **å¾®æœåŠ¡æ‹†åˆ†**: ç‹¬ç«‹çš„è·¯ç”±è¯„åˆ†æœåŠ¡
2. **æœºå™¨å­¦ä¹ ä¼˜åŒ–**: åŸºäºå†å²æ•°æ®çš„æ™ºèƒ½è·¯ç”±
3. **è¾¹ç¼˜ç¼“å­˜**: CDNçº§åˆ«çš„è·¯ç”±ç¼“å­˜

## âš¡ éƒ¨ç½²å»ºè®®

### ç”Ÿäº§ç¯å¢ƒé…ç½®
```yaml
# æ€§èƒ½ä¼˜åŒ–é…ç½®
routing:
  pre_filter_threshold: 20  # è¶…è¿‡20ä¸ªæ¸ é“å¯ç”¨é¢„ç­›é€‰
  cache_ttl: 60            # ç¼“å­˜TTL 60ç§’
  log_level: "INFO"        # ç”Ÿäº§ç¯å¢ƒä½¿ç”¨INFOçº§åˆ«
  batch_scoring: true      # å¯ç”¨æ‰¹é‡è¯„åˆ†
```

### ç›‘æ§æŒ‡æ ‡
- è·¯ç”±å“åº”æ—¶é—´ (ç›®æ ‡: <500ms)
- ç¼“å­˜å‘½ä¸­ç‡ (ç›®æ ‡: >80%)
- é¢„ç­›é€‰æ•ˆç‡ (ç›®æ ‡: å‡å°‘70%è¯„åˆ†å·¥ä½œé‡)
- å†…å­˜ä½¿ç”¨ (ç›®æ ‡: <200MB)

## ğŸ¯ ç»“è®º

é€šè¿‡ç³»ç»ŸåŒ–çš„æ€§èƒ½ä¼˜åŒ–ï¼ŒSmart AI Router çš„è·¯ç”±æ€§èƒ½æå‡äº† **65%**ï¼Œä»"åŸºæœ¬ä¸å¯ç”¨"(2.2ç§’)ä¼˜åŒ–åˆ°"å¯æ¥å—ä½¿ç”¨"(0.77ç§’)ã€‚

**å…³é”®æˆåŠŸå› ç´ **:
1. âœ… **æ­£ç¡®è¯Šæ–­ç“¶é¢ˆ**: è¯†åˆ«å‡ºç®—æ³•å¤æ‚åº¦è€Œéè¯­è¨€æ€§èƒ½é—®é¢˜
2. âœ… **åˆ†å±‚ä¼˜åŒ–ç­–ç•¥**: é¢„ç­›é€‰â†’ç®—æ³•ä¼˜åŒ–â†’æ—¥å¿—ä¼˜åŒ–çš„ç³»ç»Ÿæ€§æ”¹è¿›
3. âœ… **ä¿æŒå‘åå…¼å®¹**: æ‰€æœ‰ä¼˜åŒ–éƒ½ä¸ç ´åç°æœ‰API
4. âœ… **æ•°æ®é©±åŠ¨éªŒè¯**: æ¯ä¸ªä¼˜åŒ–éƒ½æœ‰æ˜ç¡®çš„æ€§èƒ½æ•°æ®æ”¯æ’‘

**Pythonè¯­è¨€ç»“è®º**: æ— éœ€æ›´æ¢ç¼–ç¨‹è¯­è¨€ï¼Œé€šè¿‡ç®—æ³•ä¼˜åŒ–å³å¯è¾¾åˆ°ç”Ÿäº§å¯ç”¨çš„æ€§èƒ½æ°´å¹³ã€‚

---
*æ€§èƒ½ä¼˜åŒ–å®Œæˆæ—¶é—´: 2025-08-20*  
*ä¼˜åŒ–ç‰ˆæœ¬: v2.0-performance*  
*æµ‹è¯•ç¯å¢ƒ: Windows 11, Python 3.12*